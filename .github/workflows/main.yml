name: BrainAI Industrial PDF Build

on: 
  push:
    paths:
      - 'docs/**'
  workflow_dispatch:

jobs:
  build-pdfs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rendering Tools
        run: |
          npm install -g md-to-pdf
          # Chromium Abhängigkeiten für Ubuntu
          sudo apt-get update
          sudo apt-get install -y libgbm-dev libasound2

      - name: Create Build Directory
        run: mkdir -p build

      - name: Render Industrial PDFs
        run: |
          # Wir bauen eine temporäre Config-Datei im Runner
          cat <<EOF > runner-config.js
          module.exports = {
            stylesheet: './docs/style.css',
            pdf_options: {
              format: 'A4',
              margin: '20mm',
              printBackground: true
            },
            launch_options: {
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            }
          };
          EOF

          for f in docs/*.md; do
            filename=$(basename "$f" .md)
            echo "Rendering $filename..."
            
            # Ausführung mit der temporären Runner-Config
            md-to-pdf "$f" --config-file runner-config.js
            
            # Verschieben in den Build-Ordner
            if [ -f "docs/${filename}.pdf" ]; then
              mv "docs/${filename}.pdf" "build/"
              echo "Success: build/${filename}.pdf"
            else
              # Fallback: Manchmal generiert md-to-pdf die Datei im Root
              if [ -f "${filename}.pdf" ]; then
                mv "${filename}.pdf" "build/"
              else
                echo "Error: PDF not found for $filename"
                exit 1
              fi
            fi
          done

      - name: Archive Production Docs
        uses: actions/upload-artifact@v4
        with:
          name: ProEDC-Manuals-Final
          path: build/*.pdf
