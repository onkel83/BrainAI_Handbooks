name: BrainAI Industrial PDF Build

on: 
  push:
    paths:
      - 'docs/**'
  workflow_dispatch:

jobs:
  build-pdfs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Industrial Rendering Stack
        run: |
          npm install -g md-to-pdf
          sudo apt-get update
          sudo apt-get install -y libgbm1 libasound2t64 || sudo apt-get install -y libasound2

      - name: Create Build Directory
        run: mkdir -p build

      - name: Render Industrial PDFs
        run: |
          # 1. Stabile Grund-Config f√ºr Puppeteer/Chromium
          cat <<EOF > runner-config.js
          module.exports = {
            stylesheet: './docs/style.css',
            pdf_options: {
              format: 'A4',
              margin: '20mm',
              printBackground: true
            },
            launch_options: {
              args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-gpu']
            }
          };
          EOF

          for f in docs/*.md; do
            filename=$(basename "$f" .md)
            
            # Wir ignorieren die README.md
            if [ "$filename" = "README" ]; then continue; fi

            # 2. Titel-Zuweisung (Zentral gesteuert)
            case "$filename" in
              "Lizenz") 
                DOC_TITLE="Master License Agreement (EULA)"
                DOC_SUBTITLE="LEGAL & COMPLIANCE SPECIFICATION"
                ;;
              "wasm_serverconfig") 
                DOC_TITLE="Server Integration & Hardening Guide"
                DOC_SUBTITLE="WASM & CLOUD DEPLOYMENT SPEC"
                ;;
              "ProKey") 
                DOC_TITLE="Hardware Entropy SDK Manual"
                DOC_SUBTITLE="TRNG & QUANTUM-RESISTANT ENTROPY"
                ;;
                "ProHash") 
                DOC_TITLE="Software Hash API Reference"
                DOC_SUBTITLE="DETERMINISTIC DATA INTEGRITY"
                ;;
              *) 
                DOC_TITLE="Technical Documentation"
                DOC_SUBTITLE="PROEDC INDUSTRIAL SUITE"
                ;;
            esac

            echo "Assembling: $filename"

            # 3. Den Header dynamisch generieren (Cover + Tabelle)
            cat <<EOF > header.tmp
          <div style="height: 85vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-family: 'Inter', sans-serif;">
            <h1 style="font-size: 50px; margin-bottom: 0; letter-spacing: -1px;">ProEDC Industrial Suite</h1>
            <p style="font-size: 22px; color: #555; margin-top: 10px;">$DOC_SUBTITLE</p>
            <div style="margin-top: 120px; border-top: 1px solid #ddd; width: 60%; padding-top: 20px;">
              <strong>PRODUKT-DOKUMENTATION</strong><br>
              <span style="color: #666;">BrainAI UG (haftungsbeschr√§nkt)</span>
            </div>
          </div>

          <div style="page-break-after: always;"></div>

          | BrainAI UG (haftungsbeschr√§nkt) | **PROEDC INDUSTRIAL** | üü¢ **PUBLIC CLASSIFICATION** |
          | :--- | :---: | ---: |
          | Core Architecture & Development | **$DOC_TITLE** | Access Level: Public / Beta |

          ---

          EOF

            # 4. Zusammenkleben: Header + Original-Inhalt
            cat header.tmp "$f" > "working_${filename}.md"

            # 5. Rendering
            md-to-pdf "working_${filename}.md" --config-file runner-config.js
            
            # 6. Aufr√§umen
            mv "working_${filename}.pdf" "build/${filename}.pdf"
            rm "working_${filename}.md"
            rm header.tmp
          done

      - name: Archive Production Docs
        uses: actions/upload-artifact@v4
        with:
          name: ProEDC-Manuals-Final
          path: build/*.pdf
